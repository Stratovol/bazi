{% extends "layouts/base.html" %}

{% block extrastyle %}
  <style>
    /* full grid around every cell */
    .table-fullgrid {
      border-collapse: collapse;
      width: 60% !important; /* Make table narrower */
      margin: 0 !important; /* Left align the table */
    }
    .table-fullgrid th,
    .table-fullgrid td {
      border: 1px solid #dee2e6 !important;
    }
    
    /* Make the label column narrower */
    .table-fullgrid td:last-child,
    .table-fullgrid th:last-child {
      width: 120px !important;
      max-width: 120px !important;
      min-width: 120px !important;
    }
    
    /* Make all form elements the same height */
    .uniform-height {
      height: 35px !important;
      display: flex !important;
      align-items: center !important;
      padding: 0.375rem 0.75rem !important;
    }
    
    .uniform-height input {
      border: none !important;
      outline: none !important;
      background: transparent !important;
      height: 100% !important;
      padding: 0 !important;
      flex: 1 !important;
    }
    
    .uniform-height input:focus {
      box-shadow: none !important;
    }
    
    /* Special handling for the time input with dropdown */
    .time-wrapper {
      position: relative !important;
      flex: 1 !important;
      display: flex !important;
      align-items: center !important;
    }
    
    .time-wrapper input {
      padding-right: 2.5rem !important;
    }
    
    /* Fix dropdown positioning */
    .dropdown-menu {
      position: absolute !important;
      right: 0 !important;
      left: auto !important;
      z-index: 1050 !important;
    }
    
    /* Calculate button - smaller and positioned below */
    .calculate-btn {
      width: 100% !important;
      height: 30px !important;
      margin-top: 8px !important;
      font-size: 12px !important;
      line-height: 1 !important;
      padding: 0 8px !important;
      border: none !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 5px !important;
    }
    
    .calculate-btn i {
      font-size: 10px !important;
    }
    
    /* Grayed out state */
    .grayed-out {
      background-color: #e9ecef !important;
      color: #6c757d !important;
    }
    
    .grayed-out input {
      color: #6c757d !important;
      pointer-events: none !important;
    }
    
    /* Make sure dropdown button is always clickable */
    .grayed-out .dropdown-toggle {
      pointer-events: auto !important;
    }
    
    /* Force thin GM row */
    .gm-row {
      height: 25px !important;
      max-height: 25px !important;
      line-height: 1 !important;
    }
    
    .gm-row td {
      padding: 2px 8px !important;
      height: 25px !important;
      max-height: 25px !important;
      vertical-align: middle !important;
      line-height: 1 !important;
    }
  </style>

{% endblock extrastyle %}

{% block content %}
  <div class="container-fluid py-4">

    {# — Date/Time & Moon Age/Season — #}
    <div class="row">
      <div class="col-lg-3 col-md-4 col-sm-6 col-12 mt-4">
        <div class="card shadow">
          <div class="card-body p-3">
            <!-- Date -->
            <div class="mb-3">
              <label for="dateInput" class="form-label">Date</label>
              <div class="form-control uniform-height">
                <input type="date" id="dateInput">
              </div>
            </div>
            <!-- Time -->
            <div class="mb-3">
              <label for="timeInput" class="form-label">Time</label>
              <div class="form-control uniform-height" id="timeContainer">
                <div class="time-wrapper">
                  <input type="text" id="timeInput" placeholder="HH:MM"
                         pattern="^([01]\\d|2[0-3]):([0-5]\\d)$">
                  <button class="btn btn-outline-secondary dropdown-toggle position-absolute top-50 end-0 translate-middle-y"
                          type="button" data-bs-toggle="dropdown" aria-expanded="false"
                          style="height: 20px; width: 20px; border-radius: 4px; margin-right: 6px; font-size: 8px;" id="timeDropdown">
                  </button>
                  <div class="dropdown-menu p-0"
                       style="max-height:200px; overflow-y:auto; width:6rem;">
                    <button class="dropdown-item time-option py-1 text-center text-muted" type="button"
                            data-value="unknown">Unknown Hour</button>
                    <div class="dropdown-divider"></div>
                    {% for hour in range(0,24) %}
                      {% for minute in [0,15,30,45] %}
                        {% set hh = '%02d'|format(hour) %}
                        {% set mm = '%02d'|format(minute) %}
                        <button class="dropdown-item time-option py-1 text-center" type="button"
                                data-value="{{ hh }}:{{ mm }}">{{ hh }}:{{ mm }}</button>
                      {% endfor %}
                    {% endfor %}
                  </div>
                </div>
              </div>
              <button class="btn btn-primary calculate-btn" id="calculateBtn" title="Calculate">
                <i class="fas fa-calculator"></i>
                <span>Calculate</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 col-sm-6 col-12 mt-4">
        <div class="card shadow">
          <div class="card-body p-3">
            <!-- Row 1: Moon Age & Season side by side -->
            <div class="row mb-3">
              <div class="col-5">
                <label for="moonAge" class="form-label">Moon Age</label>
                <div class="form-control bg-light uniform-height" id="moonAge" style="cursor:default;" readonly>
                  <!-- will be populated by JS -->
                </div>
              </div>
              <div class="col-5">
                <label for="season" class="form-label">Season</label>
                <div class="form-control bg-light uniform-height" id="season" style="cursor:default;" readonly>
                  <!-- will be populated by JS -->
                </div>
              </div>
            </div>

            <!-- Row 2: Cycle / Year / Month / Day -->
            <div class="row">
              <div class="col-2">
                <label class="form-label">Cycle</label>
                <div class="form-control bg-light uniform-height" id="cycleValue" style="cursor:default;" readonly>
                  <!-- JS: cycle# -->
                </div>
              </div>
              <div class="col-4">
                <label class="form-label">Year</label>
                <div class="form-control bg-light uniform-height" id="yearValue" style="cursor:default;" readonly>
                  <!-- JS: year# -->
                </div>
              </div>
              <div class="col-2">
                <label class="form-label">Month</label>
                <div class="form-control bg-light uniform-height" id="monthValue" style="cursor:default;" readonly>
                  <!-- JS: month# -->
                </div>
              </div>
              <div class="col-2">
                <label class="form-label">Day</label>
                <div class="form-control bg-light uniform-height" id="dayValue" style="cursor:default;" readonly>
                  <!-- JS: day# -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# — Stats table — #}
    <div class="row mt-4">
      <div class="col-12">

<div class="table-responsive">
  <table class="table table-fullgrid align-middle text-center mb-0">
    <thead class="table-light">
      <tr>
        <th scope="col">Hour</th>
        <th scope="col">Day</th>
        <th scope="col">Month</th>
        <th scope="col">Year</th>
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody>
      <tr class="gm-row">
        <td style="padding: 2px 8px !important; height: 25px !important;">&nbsp;</td>
        <td style="padding: 2px 8px !important; height: 25px !important;">&nbsp;</td>
        <td style="padding: 2px 8px !important; height: 25px !important;">&nbsp;</td>
        <td style="padding: 2px 8px !important; height: 25px !important;">&nbsp;</td>
        <td class="text-start" style="padding: 2px 8px !important; height: 25px !important;">GM</td>
      </tr>
      <tr style="height: 90px;">
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td class="text-start">Stem</td>
      </tr>
      <tr style="height: 90px;">
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td class="text-start">Branch</td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td class="text-start">Hidden Stems</td>
      </tr>
    </tbody>
  </table>
</div>

      </div>
    </div>

  </div>
{% endblock content %}

{% block extra_js %}
  <script src="{{ url_for('static', filename='assets/js/plugins/chartjs.min.js') }}"></script>
  <script>
    document.querySelectorAll('.time-option').forEach(btn => {
      btn.addEventListener('click', e => {
        const value = btn.dataset.value;
        const timeInput = document.getElementById('timeInput');
        const timeContainer = document.getElementById('timeContainer');
        const timeDropdown = document.getElementById('timeDropdown');
        
        if (value === 'unknown') {
          timeInput.value = 'Unknown Hour';
          timeContainer.classList.add('grayed-out');
          // Keep dropdown functional - don't disable it
        } else {
          timeInput.value = value;
          timeContainer.classList.remove('grayed-out');
        }
      });
    });
    
    // Calculate button click handler
    document.getElementById('calculateBtn').addEventListener('click', function() {
      // Add your calculation logic here
      console.log('Calculate button clicked');
      alert('Calculate functionality will be implemented here');
    });
  </script>
{% endblock extra_js %}